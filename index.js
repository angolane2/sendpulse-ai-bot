import express from "express";
import fetch from "node-fetch";

const app = express();
app.use(express.json()); // bodyParser ÑƒÐ¶Ðµ Ð½Ðµ Ð½ÑƒÐ¶ÐµÐ½

// ðŸ”¹ Ð’Ð°Ñˆ Ñ‚ÐµÐºÑÑ‚ (Ð±Ð°Ð·Ð° Ð·Ð½Ð°Ð½Ð¸Ð¹)
const companyInfo = `
Ð¯ Ð°Ð´Ð²Ð¾ÐºÐ°Ñ‚ Ð¡ÐºÑ€ÑÐ±Ñ–Ð½ ÐžÐ»ÐµÐºÑÑ–Ð¹ ÐœÐ¸ÐºÐ¾Ð»Ð°Ð¹Ð¾Ð²Ð¸Ñ‡, Ð´Ð¾ÐºÑ‚Ð¾Ñ€ ÑŽÑ€Ð¸Ð´Ð¸Ñ‡Ð½Ð¸Ñ… Ð½Ð°ÑƒÐº, Ð¿Ñ€Ð¾Ñ„ÐµÑÐ¾Ñ€. Ð”Ð¾ÑÐ²Ñ–Ð´ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸ Ð· 2007 Ñ€Ð¾ÐºÑƒ.
ÐœÐ¾Ñ— Ð¿Ð¾ÑÐ»ÑƒÐ³Ð¸: 
- Ð Ð¾Ð·Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ
- ÐÐ»Ñ–Ð¼ÐµÐ½Ñ‚Ð¸
- ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¸Ñ… Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ–Ð² Ð”Ð ÐÐ¦Ð¡
- ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ Ð´Ð¾Ð²Ñ–Ð´Ð¾Ðº Ð¿Ñ€Ð¾ ÑÑ–Ð¼ÐµÐ¹Ð½Ð¸Ð¹ ÑÑ‚Ð°Ð½ Ñ‚Ð° Ð´Ð¾Ð²Ñ–Ð´Ð¾Ðº Ð¿Ñ€Ð¾ Ð½ÐµÑÑƒÐ´Ð¸Ð¼Ñ–ÑÑ‚ÑŒ
- Ð¡ÑƒÐ´Ð¾Ð²Ñ– ÑÐ¿Ð¾Ñ€Ð¸ Ð·Ð° ÐºÐ¾Ñ€Ð´Ð¾Ð½Ð¾Ð¼

Ð¦Ñ–Ð½Ð¸: 
- ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ñ–Ñ â€” Ð²Ñ–Ð´ 1000 Ð³Ñ€Ð½ 
- ÐŸÑ€ÐµÐ´ÑÑ‚Ð°Ð²Ð½Ð¸Ñ†Ñ‚Ð²Ð¾ Ð² ÑÑƒÐ´Ñ– â€” Ð²Ñ–Ð´ 5000 Ð³Ñ€Ð½ 
- ÐŸÐ°ÐºÐµÑ‚ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ–Ð² Ð´Ð»Ñ Ñ€Ð¾Ð·Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ â€” Ð²Ñ–Ð´ 3000 Ð³Ñ€Ð½

ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¸:
ðŸ“ž +380667773733 
âœ‰ï¸ skriabinadvokat@gmail.com  
ðŸŒ https://advokat-skriabin.com
`;

// ðŸ”¹ Webhook Ð´Ð»Ñ SendPulse
app.post("/webhook", async (req, res) => {
  try {
    const userMessage = (req.body.message || "").toLowerCase();

    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        messages: [
          { 
            role: "system", 
            content: `
Ð¢Ð¸ â€” Ð²Ñ–Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¸Ð¹ Ð°ÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ Ð°Ð´Ð²Ð¾ÐºÐ°Ñ‚Ð° Ð¡ÐºÑ€ÑÐ±Ñ–Ð½Ð° ÐžÐ»ÐµÐºÑÑ–Ñ ÐœÐ¸ÐºÐ¾Ð»Ð°Ð¹Ð¾Ð²Ð¸Ñ‡Ð°. 
Ð¢Ð²Ð¾Ñ” Ð·Ð°Ð²Ð´Ð°Ð½Ð½Ñ: Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ‚Ð¸ Ð¢Ð†Ð›Ð¬ÐšÐ˜ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ñ– Ñ†ÑŒÐ¾Ð³Ð¾ Ñ‚ÐµÐºÑÑ‚Ñƒ (companyInfo). 
Ð¯ÐºÑ‰Ð¾ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ Ð¿Ð¸Ñ‚Ð°Ñ” Ñ‰Ð¾ÑÑŒ Ð¿Ð¾Ð·Ð° Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼ â€” Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹: "Ð¯ Ð¼Ð¾Ð¶Ñƒ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ‚Ð¸ Ð»Ð¸ÑˆÐµ Ñ‰Ð¾Ð´Ð¾ Ð¿Ð¾ÑÐ»ÑƒÐ³, ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ–Ð² Ñ– Ñ†Ñ–Ð½ Ð°Ð´Ð²Ð¾ÐºÐ°Ñ‚Ð° Ð¡ÐºÑ€ÑÐ±Ñ–Ð½Ð°." 

ÐžÑÑŒ Ð±Ð°Ð·Ð° Ð·Ð½Ð°Ð½ÑŒ:
${companyInfo}
            `
          },
          { role: "user", content: userMessage }
        ],
      }),
    });

    const data = await response.json();

    // Ð‘ÐµÑ€ÐµÐ¼Ð¾ Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ñ‚ÐµÐºÑÑ‚ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ–
    const reply = data?.choices?.[0]?.message?.content || "Ð’Ð¸Ð±Ð°Ñ‡Ñ‚Ðµ, ÑÑ‚Ð°Ð»Ð°ÑÑ Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°.";

    // âœ… Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ Ñƒ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ–, ÑÐºÐ¸Ð¹ Ñ‡ÐµÐºÐ°Ñ” SendPulse
    res.json({ reply });

  } catch (error) {
    console.error("ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð²ÐµÐ±Ñ…ÑƒÐºÐ°:", error);
    res.json({ reply: "Ð¡Ñ‚Ð°Ð»Ð°ÑÑ Ñ‚ÐµÑ…Ð½Ñ–Ñ‡Ð½Ð° Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°. Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ñ–Ð·Ð½Ñ–ÑˆÐµ." });
  }
});

// ðŸ”¹ Ð“Ð¾Ð»Ð¾Ð²Ð½Ð° ÑÑ‚Ð¾Ñ€Ñ–Ð½ÐºÐ° Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸
app.get("/", (req, res) => {
  res.send("âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð¿Ñ€Ð°Ñ†ÑŽÑ”. Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ¹Ñ‚Ðµ /webhook Ð´Ð»Ñ SendPulse.");
});

// ðŸ”¹ Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`âœ… Server is running on port ${PORT}`);
});
